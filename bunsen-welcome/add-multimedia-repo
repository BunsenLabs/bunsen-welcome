ADD_MULTI_TITLE=$"ADD MULTIMEDIA REPOSITORY"
ADD_MULTI_TEXT=$"The deb-multimedia repositories contain media-related packages that may be newer than those in the Debian stable repositories, or not available at all. On the other hand, packages from these repositories sometimes cause problems for some users. If in doubt, you need not add them now - you can do it later if necessary.

This will add the line:
    deb http://www.deb-multimedia.org jessie main non-free
to /etc/apt/sources.list,
and upgrade your packages to the newer ones in that repository."
ADD_MULTI_PROMPT=$"Would you like to add the deb-multimedia repositories? "
ADD_MULTI_EXTRA_ARG='N'

add_multi() {
    shopt -s nullglob # in case there is nothing in sources.list.d/
    if grep -E '^deb +(http://www|ftp://ftp).deb-multimedia.org +jessie +(main +non-free|non-free +main) *$' /etc/apt/sources.list{,.d/*}
    then
        say 'Multimedia repositories have already been added to sources.list.'
    else
        cat <<EOF | sudo tee -a /etc/apt/sources.list >/dev/null

# added by bl-welcome
# Multimedia repository
deb http://www.deb-multimedia.org jessie main non-free

EOF
        grep -q '^deb http://www.deb-multimedia.org jessie main non-free' /etc/apt/sources.list || { say 'failed to add deb-multimedia to sources.list' >&2; return 1;}
    fi
    shopt -u nullglob

    say $'\nupdating apt...\n'
    ignore_string="http://www.deb-multimedia.org.*The following signatures couldn't be verified because the public key is not available"
    if local apt_error=$(sudo apt-get update 2>&1 >/dev/tty) && ! grep -iqEv "(${ignore_string}|^$)" <<<"$apt_error"
    then
        say 'Finished update'
    else
        errorExit 'There was a problem updating apt.' "$apt_error"
    fi

    if dpkg-query -W --showformat='${db:Status-Abbrev}' deb-multimedia-keyring 2>/dev/null | grep -q '^ii' ; then
        say 'Multimedia keyring has already been installed.'
    else
        say $'Installing deb-multimedia keyring...\n'
        ignore_string1='Extracting templates from packages: 100%' # apt sends this to stderr!
        ignore_string2='Retrieving bug reports... Done' # apt-listbugs sends this to stderr!
        ignore_string3='Parsing Found/Fixed information... Done' # apt-listbugs sends this to stderr!
        if local apt_error=$(sudo apt-get install  --allow-unauthenticated deb-multimedia-keyring 2>&1 >/dev/tty) && ! grep -iqEv "(${ignore_string1}|${ignore_string2}|${ignore_string3}|^$)" <<<"$apt_error"
        then
            say 'Multimedia keyring successfully installed.'
        else
            errorExit "There were problems installing deb-multimedia-keyring" "$apt_error"
        fi
        say $'\nupdating apt again...\n'
        ignore_string="http://www.deb-multimedia.org.*The following signatures couldn't be verified because the public key is not available"
        if local apt_error=$(sudo apt-get update 2>&1 >/dev/tty) && ! grep -iqEv "(${ignore_string}|^$)" <<<"$apt_error"
        then
            say 'Finished update'
        else
            errorExit 'There was a problem updating apt.' "$apt_error"
        fi
    fi

    apt_error=''
    say $'\nUpgrading packages...\n'
    ignore_string1='Extracting templates from packages: 100%'
    ignore_string2='Retrieving bug reports... Done'
    ignore_string3='Parsing Found/Fixed information... Done'
    if apt_error=$(sudo apt-get dist-upgrade 2>&1 >/dev/tty) && ! grep -iqEv "(${ignore_string1}|${ignore_string2}|${ignore_string3}|^$)" <<<"$apt_error"
    then
        say 'Finished dist-upgrade.'
    else
        errorExit 'There was a problem with dist-upgrade.' "${apt_error:-Upgrade Aborted}"
    fi
}

if setupPage "$ADD_MULTI_TITLE" "$ADD_MULTI_TEXT" "$ADD_MULTI_PROMPT" "$ADD_MULTI_EXTRA_ARG"; then
    say $'Adding deb-multimedia repositories...\n'
    add_multi || errorExit "Errors occurred while adding deb-multimedia" 'Failed to add keyring.'
fi
