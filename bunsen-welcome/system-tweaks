setupPage $"SYSTEM TWEAKS" $"Checking your system for possible improvements..."

say 'PAE KERNEL
----------
'

if ! grep -wq pae /proc/cpuinfo
then
    say $"Your processor does not support PAE."
elif dpkg -l | grep -Eq '^ *ii +linux-image-[^ ]*(amd64|pae) '
then
    say $"You already have a PAE enabled kernel installed."
else
    say $"Your processor supports PAE, but you do not have a PAE enabled kernel installed. Would you like to install one now?" 2
    promptInstall 'PAE Kernel' 'This script will install a linux kernel that supports PAE.' 'linux-image-686-pae' || say 'Continuing in spite of install problem...' 2
fi

say '
LAPTOP CHECK
------------
'

upgradePower() {
    shopt -s nullglob # in case there is nothing in sources.list.d/
    if grep -E '^deb +http://pkg.bunsenlabs.org/debian +jessie-backports +main *$' /etc/apt/sources.list{,.d/*}
    then
        say 'BunsenLabs backports have already been added to apt sources.'
    else
        say 'Adding BunsenLabs backports to apt sources.'
        cat <<EOF | sudo tee -a /etc/apt/sources.list.d/bunsen-jessie-backports.list >/dev/null

# added by bl-welcome
# BunsenLabs backports
deb http://pkg.bunsenlabs.org/debian jessie-backports main

EOF
        grep -q '^deb http://pkg.bunsenlabs.org/debian jessie-backports main' /etc/apt/sources.list./bunsen-jessie-backports.list || {
            say 'failed to add BunsenLabs backports to apt sources.' >&2
            return 1
        }
    fi
    shopt -u nullglob

    say $'\nupdating apt...\n'
    if safeUpdate
    then
        say 'Finished update'
    else
        say 'Continuing in spite of update problem...'
    fi

    say $'Upgrading xfce4-power-manager...\n'
    if safeInstall --target-release=jessie-backports xfce4-power-manager
    then
        say 'xfce4-power-manager successfully upgraded.'
    else
        say "Failed to upgrade xfce4-power-manager."
        return 1
    fi
}

removeFdpowermon() {
    safeRemove fdpowermon || say 'Continuing in spite of removal problem...'
    say 'Commenting out fdpowermon from autostart file...' 1
    local autostart=$HOME/.config/openbox/autostart
    local autostart_bkp="$HOME/.config/openbox/autostart~bl-welcome-$( date +%FT%T )~"
    mv "$autostart" "$autostart_bkp"
    sed '/fdpowermon/s/^/#/' "$autostart_bkp" > "$autostart"
}

if sudo laptop-detect
then
    say $"This seems to be a laptop computer. It is possible to add the BunsenLabs backports repository and upgrade xfce4-power-manager from there. This will add an improved battery icon to the system tray.
The package fdpowermon, no longer needed, will be removed." 2
    prompt $"Add backports and upgrade xfce4-power-manager?" && upgradePower
else
    say $"This does not seem to be a laptop computer."
    if dpkg-query -W --showformat='${db:Status-Abbrev}' fdpowermon 2>/dev/null | grep -q '^ii'
    then
        say "You can remove the battery icon package fdpowermon." 2
        prompt $"Remove fdpowermon?" && removeFdpowermon
    fi
fi
