ADD_MULTI_TITLE=$"Deb-Multimedia Repository"
ADD_MULTI_TEXT=$"The third-party deb-multimedia repositories contain media-related packages that may be newer than those in the Debian repositories, or not available at all. On the other hand, packages from these repositories sometimes cause problems for some users, and are not supported by Debian in any way. Do not add these repositories unless you need some specific package unobtainable from Debian. If in doubt, you need not add them now - you can do it later if necessary, by running bl-welcome again.

This will add the line:
    deb http://www.deb-multimedia.org jessie main non-free
to /etc/apt/sources.list.d/deb-multi.list,
and upgrade your installed packages to the newer ones in that repository."
ADD_MULTI_PROMPT=$"Would you like to add the deb-multimedia repositories? "
ADD_MULTI_EXTRA_ARG='N'

add_multi() {
    shopt -s nullglob # in case there is nothing in sources.list.d/
    if grep -E '^deb +(http://www|ftp://ftp).deb-multimedia.org +jessie +(main +non-free|non-free +main) *$' /etc/apt/sources.list{,.d/*}
    then
        say 'Multimedia repositories have already been added to sources.list.'
    else
        cat <<EOF | sudo tee -a /etc/apt/sources.list.d/deb-multi.list >/dev/null

# added by bl-welcome
# Multimedia repository
deb http://www.deb-multimedia.org jessie main non-free

EOF
        grep -q '^deb http://www.deb-multimedia.org jessie main non-free' /etc/apt/sources.list./deb-multi.list || {
            say 'failed to add deb-multimedia to sources.list' >&2
            return 1
        }
    fi
    shopt -u nullglob

    say $'\nupdating apt...\n'
    if safeUpdate --ignore "http://www.deb-multimedia.org.*The following signatures couldn't be verified because the public key is not available"
    then
        say 'Finished update'
    else
        say 'Continuing in spite of update problem...'
    fi

    if dpkg-query -W --showformat='${db:Status-Abbrev}' deb-multimedia-keyring 2>/dev/null | grep -q '^ii'
    then
        say 'Multimedia keyring has already been installed.'
    else
        say $'Installing deb-multimedia keyring...\n'
        if safeInstall --allow-unauthenticated deb-multimedia-keyring
        then
            say 'Multimedia keyring successfully installed.'
        else
            say "Failed to install multimedia keyring."
            return 1
        fi
        say $'\nupdating apt again...\n'
        if safeUpdate --ignore "http://www.deb-multimedia.org.*The following signatures couldn't be verified because the public key is not available"
        then
            say 'Finished update'
        else
            say 'Continuing in spite of update problem...'
        fi
    fi

    say $'\nUpgrading packages...\n'
    if safeUpgrade --dist-upgrade
    then
        say 'Finished dist-upgrade.'
    else
        say 'dist-upgrade failed'
        return 1
    fi
}

if setupPage "$ADD_MULTI_TITLE" "$ADD_MULTI_TEXT" "$ADD_MULTI_PROMPT" "$ADD_MULTI_EXTRA_ARG"; then
    say $'Adding deb-multimedia repositories...\n'
    if add_multi
    then
        say "Successfully added deb-multimedia repositories and upgraded packages."
    else
        say "Failed to add deb-multimedia repositories.

...going to next page."
    fi
fi
