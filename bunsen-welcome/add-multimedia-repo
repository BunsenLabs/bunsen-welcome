ADD_MULTI_TITLE=$"ADD MULTIMEDIA REPOSITORY"
ADD_MULTI_TEXT=$"The deb-multimedia repositories contain media-related packages that may be newer than those in the Debian stable repositories, or not available at all. On the other hand, packages from these repositories sometimes cause problems for some users. If in doubt, you need not add them now - you can do it later if necessary.

This will add the line:
    deb http://www.deb-multimedia.org jessie main non-free
to /etc/apt/sources.list,
and upgrade your packages to the newer ones in that repository."
ADD_MULTI_PROMPT=$"Would you like to add the deb-multimedia repositories? "
ADD_MULTI_EXTRA_ARG='N'

add_multi() {

    if dpkg-query -W --showformat='${db:Status-Abbrev}' deb-multimedia-keyring 2>/dev/null | grep -q '^ii' ; then
        say 'Multimedia keyring has already been installed.'
    else
        say $'installing deb-multimedia keyring...\n'
        local tmpdir=$(mktemp -d)
        wget -P "$tmpdir" http://www.deb-multimedia.org/pool/main/d/deb-multimedia-keyring/deb-multimedia-keyring_2015.6_all.deb
        [[ -e "$tmpdir"/deb-multimedia-keyring_2015.6_all.deb ]] || { say 'failed to download deb-multimedia keyring' >&2; return 1;}
        sudo dpkg -i "$tmpdir"/deb-multimedia-keyring_2015.6_all.deb || { say 'failed to install deb-multimedia keyring' >&2; return 1;}
        rm -r "$tmpdir"
    fi

    if grep -E '^deb +(http://www|ftp://ftp).deb-multimedia.org +jessie +(main +non-free|non-free +main) *$' /etc/apt/sources.list{,.d/*}
    then
        say 'Multimedia repositories have already been added.'
    else
        cat <<EOF | sudo tee -a /etc/apt/sources.list >/dev/null

# added by bl-welcome
# Multimedia repository
deb http://www.deb-multimedia.org jessie main non-free

EOF
        grep -q '^deb http://www.deb-multimedia.org jessie main non-free' /etc/apt/sources.list || { say 'failed to add deb-multimedia to sources.list' >&2; return 1;}
    fi

    say $'\nupdating apt...\n'
    if local apt_error=$(sudo apt-get update 2>&1 >/dev/tty) && [[ -z $apt_error ]]
    then
        say 'Finished update'
    else
        errorExit 'There was a problem updating apt.' "$apt_error"
    fi

    apt_error=''
    say '\nupgrading packages...\n'
    ignore_string1='Extracting templates from packages: 100%' # apt sends this to stderr!
    ignore_string2='Retrieving bug reports... Done' # apt-listbugs sends this to stderr!
    ignore_string3='Parsing Found/Fixed information... Done' # apt-listbugs sends this to stderr!
    if apt_error=$(sudo apt-get dist-upgrade 2>&1 >/dev/tty) && ! grep -iqEv "(${ignore_string1}|${ignore_string2}|${ignore_string3}|^$)" <<<"$apt_error"
    then
        say 'Finished dist-upgrade.'
    else
        errorExit 'There was a problem with dist-upgrade.' "$apt_error"
    fi
}

if setupPage "$ADD_MULTI_TITLE" "$ADD_MULTI_TEXT" "$ADD_MULTI_PROMPT" "$ADD_MULTI_EXTRA_ARG"; then
    say $'Adding deb-multimedia repositories...\n'
    add_multi || errorExit "Errors occurred while adding deb-multimedia" 'Failed to add keyring.'
fi
