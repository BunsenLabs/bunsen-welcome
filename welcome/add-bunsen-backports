ADD_BL_BACKPORTS_TITLE=$"BunsenLabs Backports"
ADD_BL_BACKPORTS_TEXT=$"BunsenLabs backports are packages taken from other Debian or Debian-based releases, or other sources such as GitHub, adjusted and recompiled for usage on Debian stable.\
 If you enable this repository you will be able to upgrade some programs to newer versions, or install some programs not available in Debian stable.

However, BunsenLabs backports are not tested extensively, and are provided on an as-is basis, with risk of incompatibilities with other components in Debian stable.\
 It is therefore recommended to consider carefully whether you need a backported package before choosing to install it.

This will add the line:

 deb $bunsen_mirror ${debian_base}-backports main

to /etc/apt/sources.list.d/bunsen-${debian_base}-backports.list,
allowing you to upgrade or install packages using that repository."
ADD_BL_BACKPORTS_PROMPT=$"Would you like to enable the BunsenLabs Backports repositories?"
ADD_BL_BACKPORTS_EXTRA_ARG='N'

# If Debian backports were added on previous page, apt update will not yet have been run
# so they will not be detected by haveDebianBackports()
# A simple test of the code added on that page is enough here.
addedDebianBackports() {
    grep -qs "^deb $default_mirror ${debian_base}-backports main contrib non-free\$" /etc/apt/sources.list.d/debian-"${debian_base}"-backports.list || return 1
}

# use key in global array repo_status generated by getRepoStatus() in 'apt-update-check-upgrade' or 'restart'
haveBunsenBackports() {
    [[ -n ${repo_status[bunsen_bkpt_main]-} ]] && return 0
    return 1
}

addBunsenBackports() {
    if haveBunsenBackports
    then
        say 'BunsenLabs backports have already been added to apt sources.' 2
    else
        say $'\nAdding BunsenLabs backports to apt sources...\n' 1
        local bp_repo="# added by bl-welcome
# BunsenLabs backports
deb $bunsen_mirror ${debian_base}-backports main

"
        sudo tee <<< "$bp_repo" /etc/apt/sources.list.d/bunsen-"${debian_base}"-backports.list >/dev/null
        grep -q "^deb $bunsen_mirror ${debian_base}-backports main" /etc/apt/sources.list.d/bunsen-"${debian_base}"-backports.list || {
            say 'Failed to add BunsenLabs backports to apt sources.' pause >&2
            return 1
        }
        triggerAptUpdate
    fi
}

if haveBunsenBackports
then
    setupPage "$ADD_BL_BACKPORTS_TITLE" $"BunsenLabs backports have already been added to apt sources."
else
    if setupPage "$ADD_BL_BACKPORTS_TITLE" "$ADD_BL_BACKPORTS_TEXT" "$ADD_BL_BACKPORTS_PROMPT" "$ADD_BL_BACKPORTS_EXTRA_ARG"; then
        if addBunsenBackports
        then
            say "Successfully added BunsenLabs backports.\
 You can add or upgrade packages with the command:
 sudo apt-get install -t ${debian_base}-backports <packagename>

 (NB ${debian_base}-backports is correct!)
 " pause
            if ! haveDebianBackports && ! addedDebianBackports
            then
                say "You do not have Debian Backports enabled.
Some BunsenLabs Backports packages depend on Debian backported versions of other packages."
                if prompt "Would you like to add the Debian Backports now?"
                then
                    if addDebianBackports
                    then
                        say "Successfully added Debian backports.\
             You can add or upgrade packages with the command:
             sudo apt-get install -t ${debian_base}-backports <packagename>" pause
                    else
                        say "Failed to add Debian backports." 3
                    fi
                fi
            fi
        else
            say "Failed to add BunsenLabs backports, going to next page." 3
        fi
    fi
fi
